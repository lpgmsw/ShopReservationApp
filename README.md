# ShopReservationApp

店舗予約システム - ユーザーが店舗を検索して予約し、店舗管理者が予約を管理できるWebアプリケーション

[![Next.js](https://img.shields.io/badge/Next.js-14.2-black?logo=next.js)](https://nextjs.org/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.x-blue?logo=typescript)](https://www.typescriptlang.org/)
[![Supabase](https://img.shields.io/badge/Supabase-PostgreSQL-green?logo=supabase)](https://supabase.com/)

---

## 📋 目次

- [概要](#概要)
- [技術スタック](#技術スタック)
- [主な機能](#主な機能)
- [ユースケース](#ユースケース)
- [セットアップ](#セットアップ)
- [プロジェクト構成](#プロジェクト構成)
- [ドキュメント](#ドキュメント)

---

## 概要

ShopReservationAppは、店舗とユーザーをつなぐ予約管理プラットフォームです。

### 主要な特徴

- **3つのロール**: ユーザー、店舗管理者、システム管理者
- **リアルタイム予約管理**: Supabaseによる高速なデータ同期
- **セキュアな設計**: Row Level Security (RLS) による行レベルのアクセス制御
- **レスポンシブUI**: モバイル・デスクトップ対応
- **型安全**: TypeScriptによる堅牢な開発

---

## 技術スタック

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js** | 14.2.x | フレームワーク（App Router） |
| **React** | 18.x | UIライブラリ |
| **TypeScript** | 5.x | 型安全な開発 |
| **Tailwind CSS** | 3.x | スタイリング |
| **React Hook Form** | - | フォーム管理・バリデーション |

### バックエンド

| 技術 | 用途 |
|------|------|
| **Supabase** | BaaS (Backend as a Service) |
| **PostgreSQL** | リレーショナルデータベース |
| **Supabase Auth** | 認証・認可 |
| **Row Level Security (RLS)** | データベース層でのアクセス制御 |

### テスト・品質管理

| 技術 | 用途 |
|------|------|
| **Jest** | 単体テスト |
| **React Testing Library** | コンポーネントテスト |
| **Playwright** | E2Eテスト |
| **ESLint** | 静的解析 |

### アーキテクチャ

- **Clean Architecture**: 機能ごとのレイヤー分離
- **Feature-based Directory Structure**: ドメインごとのディレクトリ構成
- **Server Components / Client Components**: Next.js App Routerの最適化

---

## 主な機能

### 👤 ユーザー機能

| 機能 | 説明 |
|------|------|
| アカウント管理 | 新規登録・ログイン・ログアウト・情報編集 |
| 店舗検索 | 店舗名・日付・時間での絞り込み検索 |
| 予約作成 | カレンダーで日付選択、30分単位の時間指定 |
| 予約管理 | 予約履歴の閲覧・変更・キャンセル |
| 予約制限 | 1ユーザー1予約まで、前日までの変更・キャンセル |

**予約ルール:**
- 予約時間単位: 30分（例: 10:00, 10:30, 11:00...）
- 1つの時間枠に対する予約: 店舗ごとに設定された受付可能人数まで（先着順）
- 予約可能期間: 1週間先まで
- 同時予約数: 1ユーザー1予約まで
- 変更・キャンセル: 前日まで

### 🏪 店舗管理者機能

| 機能 | 説明 |
|------|------|
| アカウント管理 | 新規登録・ログイン・ログアウト |
| 店舗情報管理 | 店舗名・営業時間・予約受付時間・営業日・1枠あたりの予約受付可能人数の設定 |
| 予約一覧表示 | 自店舗の予約をページネーション付きで表示（予約枠の充足率も表示） |
| RLS対応 | 自店舗のデータのみアクセス可能 |

**制約:**
- 1管理者につき1店舗のみ登録可能

### 🔧 システム管理者機能

| 機能 | 説明 |
|------|------|
| アカウント管理 | 新規登録・ログイン・ログアウト |
| ダッシュボード | システム管理者専用マイページ |
| 店舗一覧 | 全店舗の一覧表示（ページネーション対応） |
| 店舗編集 | 任意の店舗情報の編集権限 |
| 店舗削除 | 任意の店舗の削除権限 |
| 全予約閲覧 | 全店舗の予約一覧閲覧権限 |
| RLS対応 | システム管理者ロールに基づくアクセス制御 |

---

## ユースケース

### 📱 ユーザーのストーリー

#### シナリオ1: 初回予約
```
1. トップページから「新規登録」をクリック
2. ユーザー名、メールアドレス、パスワードを入力して登録
3. マイページで店舗名を検索（例: "新宿店"）
4. 検索結果から気になる店舗の「予約する」をクリック
5. カレンダーで希望日を選択、時間帯を選択（30分単位）
6. 予約者名とコメントを入力して予約確定
7. 予約履歴で確認可能
```

#### シナリオ2: 予約の変更
```
1. マイページのサイドメニューから「予約履歴」をクリック
2. 変更したい予約の「変更」ボタンをクリック
3. 新しい日時を選択して更新（注: 前日までのみ変更可能）
```

#### シナリオ3: 予約のキャンセル
```
1. 予約履歴から該当予約を表示
2. 「キャンセル」ボタンをクリック
3. 確認ダイアログでOKを選択（注: 前日までのみキャンセル可能）
```

### 🏪 店舗管理者のストーリー

#### シナリオ1: 店舗の開設
```
1. 店舗管理者登録ページでアカウント作成
2. 店舗設定画面で以下を入力:
   - 店舗名
   - 営業時間（例: 10:00 - 20:00）
   - 予約受付時間（例: 10:15 - 19:00）
   - 営業日（例: 月〜金）
   - 定休日（例: 土・日）
3. 「登録」ボタンで店舗情報を保存
```

#### シナリオ2: 予約の確認
```
1. 店舗管理者マイページにログイン
2. 「予約一覧」メニューをクリック
3. 自店舗の予約が一覧表示される
4. 予約者名、日時、コメントを確認
5. ページネーションで過去・未来の予約を閲覧
```

#### シナリオ3: 店舗情報の更新
```
1. マイページの「店舗設定」をクリック
2. 営業時間や定休日を変更
3. 「更新」ボタンで保存
```

### 🔧 システム管理者のストーリー

#### シナリオ1: システム管理者ログイン
```
1. システム管理者登録ページでアカウント作成
   - ユーザー名、メールアドレス、パスワードを入力
2. 登録成功後、ダッシュボードに遷移
3. ログイン画面からメールアドレスとパスワードでログイン可能
```

#### シナリオ2: 全店舗の管理
```
1. ダッシュボードから「店舗一覧」をクリック
2. 全店舗が一覧表示される（ページネーション対応）
3. 各店舗の情報（店舗名、営業時間、予約受付時間、受付可能人数）を確認
4. 任意の店舗の「編集」ボタンをクリックして情報を修正
5. 「削除」ボタンで店舗を削除（確認ダイアログ表示）
```

#### シナリオ3: 予約状況の確認
```
1. ダッシュボードから「予約一覧」をクリック
2. 全店舗の全予約が一覧表示される
3. 予約者名、店舗名、日時、予約枠の充足率を確認
4. ページネーションで過去・未来の予約を閲覧
```

---

## プロジェクト構成

```
ShopReservationApp/
├── app/                          # Next.js App Router
│   ├── shop-admin/               # 店舗管理者側画面
│   │   ├── login/                # ログイン
│   │   ├── signup/               # アカウント登録
│   │   ├── shop-settings/        # 店舗設定
│   │   └── reservations/         # 予約一覧
│   ├── system-admin/             # システム管理者側画面
│   │   ├── login/                # ログイン
│   │   ├── signup/               # アカウント登録
│   │   ├── dashboard/            # ダッシュボード（マイページ）
│   │   └── shops/                # 店舗一覧・編集・削除
│   ├── user/                     # ユーザー側画面
│   │   ├── login/                # ログイン
│   │   ├── signup/               # アカウント登録
│   │   ├── mypage/               # マイページ
│   │   ├── reservation/          # 予約作成
│   │   ├── reservations/         # 予約履歴
│   │   └── settings/             # ユーザー情報編集
│   └── page.tsx                  # トップページ
├── features/                     # ビジネスロジック（Feature-based）
│   ├── auth/                     # 認証機能
│   ├── shop/                     # 店舗機能
│   ├── shop-search/              # 店舗検索機能
│   └── reservation/              # 予約機能
│       ├── components/           # 予約関連コンポーネント
│       ├── hooks/                # カスタムフック
│       ├── types/                # 型定義
│       └── utils/                # ユーティリティ関数
├── components/                   # 共通UIコンポーネント
│   ├── shop-admin/               # 店舗管理者用コンポーネント
│   └── ui/                       # 汎用UIコンポーネント
├── lib/                          # ライブラリ・ユーティリティ
│   └── supabase/                 # Supabaseクライアント
├── supabase/                     # Supabase設定
│   └── migrations/               # データベースマイグレーション
├── __tests__/                    # テストファイル
├── docs/                         # ドキュメント
│   ├── design.md                 # 設計書
│   ├── understanding-rls.md      # RLS解説
│   └── directory-structure.md    # ディレクトリ構造詳細
└── _docs/                        # 実装ログ
```

---

## ドキュメント

### データベース設計

主要テーブル:

| テーブル名 | 説明 |
|-----------|------|
| `users` | ユーザー情報（全ロール共通） |
| `shops` | 店舗情報（1管理者1店舗） |
| `reservations` | 予約情報（アクティブな予約） |
| `past_reservations` | 過去予約アーカイブ（将来実装予定） |

### セキュリティ

#### Row Level Security (RLS)

本プロジェクトでは、PostgreSQLのRLS機能を使用してデータベース層でアクセス制御を実施しています。

**主要なRLSポリシー:**

- **reservations テーブル**:
  - ユーザーは自分の予約のみ閲覧・作成可能
  - 店舗管理者は自店舗の予約を閲覧可能

- **shops テーブル**:
  - 店舗管理者は自分の店舗のみ編集可能
  - 一般ユーザーは全店舗を閲覧可能

- **users テーブル**:
  - ユーザーは自分のレコードのみ編集可能

#### 認証・認可

- **認証**: Supabase Authによるメールアドレス + パスワード
- **セッション管理**: Supabase Authが自動管理
- **パスワードハッシュ化**: Supabase Authが自動実行
- **ロールベースアクセス制御**: `users.role`カラムで管理
  - `user`: 一般ユーザー
  - `shop_manager`: 店舗管理者
  - `system_admin`: システム管理者

---

## ライセンス

このプロジェクトは学習目的で作成されています。

---

## 開発チーム

- 開発環境: Next.js 14.2 + TypeScript + Supabase
- 設計手法: Clean Architecture + TDD
- AI支援: Claude Code

---

最終更新: 2026-01-01
